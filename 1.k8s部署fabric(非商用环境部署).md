- [k8s部署fabric配置文件](https://github.com/horan-geeker/fabric-on-k8s)
- [Fabric-solo on k8s](https://blog.csdn.net/scylhy/article/details/90029163)
- [IBM解决方案blockchain-network-on-kubernetes](https://github.com/IBM/blockchain-network-on-kubernetes)
---

# 基础环境搭建
- 部署k8s集群
- 部署配套的软件

## 部署k8s集群

### 购买服务器：

- node1: 140.82.8.255 (master)

- node2: 108.61.128.115

- node3: 149.28.51.186

- node4: 45.76.2.114

### 安装基础环境：

1. 使用《0.1 golang与docker环境配置》配置每个节点的基础环境

2. 使用《0.2 kubernetes部署》来为每个节点配置k8s组件

## 部署fabric


### 发送文件到服务器
```
tar -czvf K8sDeployFabric.tar.gz ./K8sDeployFabric
scp -r K8sDeployFabric.tar.gz root@140.82.8.255:/root
scp -r K8sDeployFabric.tar.gz root@108.61.128.115:/root
scp -r K8sDeployFabric.tar.gz root@149.28.51.186:/root
scp -r K8sDeployFabric.tar.gz root@45.76.2.114:/root

#登录主机，分别在主机上解压文件包
ssh root@140.82.8.255 
ssh root@108.61.128.115 
ssh root@149.28.51.186 
ssh root@45.76.2.114 
tar -xzvf K8sDeployFabric.tar.gz
```

### 测试fabric

```
kubectl get pods -n org1-example-com
#输出
NAME                         READY   STATUS    RESTARTS   AGE
ca-7f8c794767-pllt2          1/1     Running   0          35m
cli-59444ddfc6-fm8vx         1/1     Running   0          35m
peer0-org1-c5df7596d-9czfp   1/1     Running   0          5m39s

kubectl exec -it cli-5b74654b95-f24lc    -n  org1-example-com /bin/bash

cd ./scripts && ./script.sh
#正确输出结果为
90
```

## 其他命令

如果发现一些pod没有运行，例如kafka没有运行，则采用找原因，微调的方式调试。

```
kubectl delete deployment kafka0 -n  fabric-zk-kafka 
kubectl delete service kafka0 -n  fabric-zk-kafka
kubectl apply -f K8sDeployFabric/deploy/k8s-kafka0.yaml 
```
在删除deployment之后，名词空间处于terminating，解决办法：见报错2:
```
[root@node1 deploy]# kubectl get ns
NAME               STATUS        AGE
default            Active        2d19h
example-com        Terminating   144m
fabric-zk-kafka    Terminating   144m
kube-node-lease    Active        2d19h
kube-public        Active        2d19h
kube-system        Active        2d19h
org1-example-com   Terminating   144m
org2-example-com   Terminating   144m
```

# 报错处理：

1. peer镜像拉取不下来,查日志发现
Get https://registry-1.docker.io/v2/hyperledger/fabric-peer/manifests/sha256:4aced6e0451704ec9e8c8dba35da00e64c73ca1ac9e54cf2b79cf586a76b6fa4: dial tcp: lookup registry-1.docker.io on 108.61.10.10:53: read udp 140.82.8.255:48302->108.61.10.10:53: i/o timeout


- [docker pull下载镜像报错Get https://registry-1.docker.io/v2/l](https://cloud.tencent.com/developer/article/1368054)


```
yum install bind-utils -y
dig @114.114.114.114 registry-1.docker.io
输出
...
;; ANSWER SECTION:
registry-1.docker.io.	50	IN	A	34.197.189.129
registry-1.docker.io.	50	IN	A	3.221.133.86
registry-1.docker.io.	50	IN	A	3.210.179.11
registry-1.docker.io.	50	IN	A	3.224.11.4
registry-1.docker.io.	50	IN	A	34.192.182.239
registry-1.docker.io.	50	IN	A	34.199.77.19
registry-1.docker.io.	50	IN	A	34.199.40.84
registry-1.docker.io.	50	IN	A	3.224.75.242
..

vim /etc/hosts
添加如下：
34.197.189.129    registry-1.docker.io

```

2. 关于删除处于状态为terminating的namespace

为了解决这个问题，我花费了两个多小时！！！这是一个大问题，资源网址收集如下：

- [k8s系列---故障](https://blog.csdn.net/weixin_30905133/article/details/95949538)
- [K8S从懵圈到熟练 - 我们为什么会删除不了集群的命名空间？](https://www.jianshu.com/p/85e2779302de)


终端1：
```
[root@node1 deploy]# kubectl proxy --port=8001
Starting to serve on 127.0.0.1:8001
```
终端2：:
```
[root@node1 deploy]# kubectl get ns
NAME               STATUS        AGE
default            Active        2d19h
example-com        Terminating   144m
fabric-zk-kafka    Terminating   144m
kube-node-lease    Active        2d19h
kube-public        Active        2d19h
kube-system        Active        2d19h
org2-example-com   Terminating   144m
[root@node1 deploy]# kubectl get namespace org2-example-com -o json > org2-example-com.json
[root@node1 deploy]# ls
k8s-kafka0.yaml  k8s-kafka2.yaml  k8s-orderer.yaml   k8s-peerOrg2.yaml            k8s-zookeeper.yaml     org2-example-com.json
k8s-kafka1.yaml  k8s-kafka3.yaml  k8s-peerOrg1.yaml  k8s-zk-kafka-namespace.yaml  org1-example-com.json
[root@node1 deploy]# vim org2-example-com.json 
[root@node1 deploy]# curl -k -H "Content-Type: application/json" -X PUT --data-binary @org2-example-com.json http://127.0.0.1:8001/api/v1/namespaces/org2-example-com/finalize
{
  "kind": "Namespace",
  "apiVersion": "v1",
  "metadata": {
    "name": "org2-example-com",
    "selfLink": "/api/v1/namespaces/org2-example-com/finalize",
    "uid": "ab7da11a-7a71-4cd4-ba7d-ff77f1cd25ae",
    "resourceVersion": "363310",
    "creationTimestamp": "2019-10-27T07:47:58Z",
    "deletionTimestamp": "2019-10-27T08:34:42Z",
    "annotations": {
      "kubectl.kubernetes.io/last-applied-configuration": "{\"apiVersion\":\"v1\",\"kind\":\"Namespace\",\"metadata\":{\"annotations\":{},\"name\":\"org2-example-com\"}}\n"
    }
  },
  "spec": {
    
  },
  "status": {
    "phase": "Terminating",
    "conditions": [
      {
        "type": "NamespaceDeletionDiscoveryFailure",
        "status": "True",
        "lastTransitionTime": "2019-10-27T08:34:47Z",
        "reason": "DiscoveryFailed",
        "message": "Discovery failed for some groups, 1 failing: unable to retrieve the complete list of server APIs: metrics.k8s.io/v1beta1: the server is currently unable to handle the request"
      },
      {
        "type": "NamespaceDeletionGroupVersionParsingFailure",
        "status": "False",
        "lastTransitionTime": "2019-10-27T08:34:48Z",
        "reason": "ParsedGroupVersions",
        "message": "All legacy kube types successfully parsed"
      },
      {
        "type": "NamespaceDeletionContentFailure",
        "status": "False",
        "lastTransitionTime": "2019-10-27T08:34:48Z",
        "reason": "ContentDeleted",
        "message": "All content successfully deleted"
      }
    ]
  }
}
[root@node1 deploy]#kubectl get ns
NAME              STATUS        AGE
default           Active        2d19h
example-com       Terminating   152m
fabric-zk-kafka   Terminating   152m
kube-node-lease   Active        2d19h
kube-public       Active        2d19h
kube-system       Active        2d19h
```
3. kafka报错Error from server: Get https://149.28.51.186:10250/containerLogs/fabric-zk-kafka/kafka0-bf7695fdd-nmzz6/kafka0?follow=true: dial tcp 149.28.51.186:10250: connect: no route to host

解决办法，这是防火墙的原因，要么在节点上关闭指定端口的防火墙，要么打开指定防火墙的指定端口。
```
systemctl stop firewalld
```
